<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>第3章 内核编程基础 | Gcmz Blog</title><meta name="author" content="Gcmz"><meta name="copyright" content="Gcmz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="第3章 内核编程基础"><meta name="application-name" content="第3章 内核编程基础"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="第3章 内核编程基础"><meta property="og:url" content="http://example.com/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC3%E7%AB%A0%20%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/index.html"><meta property="og:site_name" content="Gcmz Blog"><meta property="og:description" content="3.1 上下文环境上下文（Context）泛指CPU在执行代码时，该代码所处的环境与状态。通俗来讲，这些环境状态包括（不仅限）：当前代码所属线程、中断请求级别、CPU寄存器各状态等。 无论是驱动入口函数，还是驱动卸载函数，都隶属于进程ID为4的进程，在笔者的Windows 10测试环境中，进程ID为"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="Gcmz"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="3.1 上下文环境上下文（Context）泛指CPU在执行代码时，该代码所处的环境与状态。通俗来讲，这些环境状态包括（不仅限）：当前代码所属线程、中断请求级别、CPU寄存器各状态等。 无论是驱动入口函数，还是驱动卸载函数，都隶属于进程ID为4的进程，在笔者的Windows 10测试环境中，进程ID为"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC3%E7%AB%A0%20%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: undefined,
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Gcmz","link":"链接: ","source":"来源: Gcmz Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Gcmz Blog',
  title: '第3章 内核编程基础',
  postAI: '',
  pageFillDescription: '3.1 上下文环境, 3.2 中断请求级别, 3.3 驱动异常, 3.4 字符串操作, 练习点：字符串操作函数库, 1. 基本字符串操作, 2. 内存与宽字符操作, 3. 转换与格式化, 4. 多字节与宽字符转换, 5. 其他工具函数, 示例代码, 注意事项, 3.5 链表, 3.5.1 头节点初始化, 3.5.2 节点插入, 3.5.3 链表遍历, 思考点：windbg时怎么打印？, 3.5.4 节点移除, 注意点：锁中不建议释放内存, 3.6 自旋锁, 3.6.1 使用自旋锁, 注意点 锁一般不使用局部变量, 3.6.2 在双向链表中使用自旋锁, 3.6.3 使用队列自旋锁提高性能, 3.7 内存分配, 3.7.1 常规内存分配, 3.7.2 旁视列表, 练习点旁氏列表, 3.8 对象与句柄, 对象与句柄, 引用计数, 问题点指针计数如何独立增加与减少?, 练习点 CreateEvent 观察句柄值与对象, 3.9 注册表, 3.9.1 注册表的打开与关闭, ZwCreateKey, 3.9.2 注册表的修改, 3.9.3 注册表的读取, 练习点：封装注册表操作函数, 3.10 文件操作, 补充点：ShareAccess 参数有做过对独占的判断, 3.10.2 文件的读写, 3.11 线程与事件, 3.11.1 使用系统线程, 3.11.2 使用同步事件上下文环境上下文泛指在执行代码时该代码所处的环境与状态通俗来讲这些环境状态包括不仅限当前代码所属线程中断请求级别寄存器各状态等无论是驱动入口函数还是驱动卸载函数都隶属于进程为的进程在笔者的测试环境中进程为的进程为进程中断请求级别驱动异常主动引发蓝屏的函数这个函数的原型如下字符串操作的初始化常用的初始化函数为下面为读者介绍的拷贝操作拷贝操作可以使用函数原型如下练习点字符串操作函数库在中处理宽字符的字符串操作函数主要定义在或头文件中以下是常见的宽字符字符串操作函数及其功能基本字符串操作函数功能描述返回宽字符串的长度不包括终止符将复制到需确保空间足够复制的前个字符到必要时截断或填充将追加到末尾需确保空间足够追加的前个字符到比较和返回值为相等正数或负数比较前个字符查找字符在中首次出现的位置未找到返回查找字符在中最后一次出现的位置查找子串在中的位置内存与宽字符操作函数功能描述从复制个宽字符到安全地复制个宽字符处理内存重叠将的前个宽字符设置为比较和的前个宽字符在的前个字符中查找转换与格式化函数功能描述格式化输出到宽字符串类似可变参数版本的从输入文件字符串读取格式化宽字符数据多字节与宽字符转换函数功能描述多字节字符串宽字符串宽字符串多字节字符串多字节字符宽字符带状态宽字符多字节字符带状态其他工具函数函数功能描述分割宽字符串线程安全版本类似根据本地化规则比较字符串用于排序转换字符串为可比较形式用于本地化排序示例代码启用本地化支持世界拼接宽字符串结果输出世界注意事项宽字符常量使用前缀如宽字符串本地化设置调用以确保多字节宽字符转换正确安全性优先使用带的限制长度函数如而非避免缓冲区溢出链表头节点初始化节点插入链表遍历思考点时怎么打印不在结构体头部如何快速便利整条链表查看时链表结构节点移除注意点锁中不建议释放内存自旋锁使用自旋锁初始化获取一个自旋锁使用自旋锁注意点锁一般不使用局部变量在双向链表中使用自旋锁使用队列自旋锁提高性能队列自旋锁的使用和普通自旋锁的使用方法基本一样初始化自旋锁也是使用函数唯一不同的地方是在获取和释放自旋锁时需要使用新的函数内存分配常规内存分配旁视列表练习点旁氏列表相同的大小的结构体的开辟使用一个旁氏列表就够了笔者曾经犯过两条链表都是相同的结构体但是用了两条旁氏列表的错误对象与句柄对象与句柄引用计数问题点指针计数如何独立增加与减少练习点观察句柄值与对象注册表注册表的打开与关闭注册表的修改注册表的读取练习点封装注册表操作函数文件操作文件的打开与关闭补充点参数有做过对独占的判断修改时需要调用一个函数文件的读写线程与事件使用系统线程使用同步事件通俗一点讲也就是同步事件在处理完后会自动设置无信号状态下次会继续等待通告事件会一直开绿灯直到调用重新设置为无信号状态',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-07-24 23:59:28',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">Gcmz Blog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" alt="微信" src="/null"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="/null"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">13</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">28</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B-%E8%B0%AD%E6%96%87-%E9%99%88%E9%93%AD%E9%9C%96-%E8%91%97/" itemprop="url">Windows内核编程(谭文 陈铭霖 著)</a><i class="anzhiyufont anzhiyu-icon-angle-right post-meta-separator"></i><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B-%E8%B0%AD%E6%96%87-%E9%99%88%E9%93%AD%E9%9C%96-%E8%91%97/%E5%AD%A6%E4%B9%A0/" itemprop="url">学习</a></span><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">第3章 内核编程基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-07-23T15:19:12.106Z" title="发表于 2025-07-23 23:19:12">2025-07-23</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-07-24T15:59:28.628Z" title="更新于 2025-07-24 23:59:28">2025-07-24</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为深圳"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>深圳</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC3%E7%AB%A0%20%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"><header><a class="post-meta-categories" href="/categories/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B-%E8%B0%AD%E6%96%87-%E9%99%88%E9%93%AD%E9%9C%96-%E8%91%97/" itemprop="url">Windows内核编程(谭文 陈铭霖 著)</a><a class="post-meta-categories" href="/categories/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B-%E8%B0%AD%E6%96%87-%E9%99%88%E9%93%AD%E9%9C%96-%E8%91%97/%E5%AD%A6%E4%B9%A0/" itemprop="url">学习</a><h1 id="CrawlerTitle" itemprop="name headline">第3章 内核编程基础</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Gcmz</span><time itemprop="dateCreated datePublished" datetime="2025-07-23T15:19:12.106Z" title="发表于 2025-07-23 23:19:12">2025-07-23</time><time itemprop="dateCreated datePublished" datetime="2025-07-24T15:59:28.628Z" title="更新于 2025-07-24 23:59:28">2025-07-24</time></header><h2 id="3-1-上下文环境"><a href="#3-1-上下文环境" class="headerlink" title="3.1 上下文环境"></a>3.1 上下文环境</h2><p>上下文（Context）泛指CPU在执行代码时，该代码所处的环境与状态。通俗来讲，这些环境状态包括（不仅限）：当前代码所属线程、中断请求级别、CPU寄存器各状态等。</p>
<p>无论是驱动入口函数，还是驱动卸载函数，都隶属于进程ID为4的进程，在笔者的Windows 10测试环境中，进程ID为4的进程为SYSTEM进程，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282236436.png" alt="image.png"></p>
<h2 id="3-2-中断请求级别"><a href="#3-2-中断请求级别" class="headerlink" title="3.2 中断请求级别"></a>3.2 中断请求级别</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282237986.png" alt="image.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282238441.png" alt="image.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282241386.png" alt="image.png"></p>
<h2 id="3-3-驱动异常"><a href="#3-3-驱动异常" class="headerlink" title="3.3 驱动异常"></a>3.3 驱动异常</h2><p>主动引发蓝屏的函数：KeBugCheckEx，这个函数的原型如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282244070.png" alt="image.png"></p>
<h2 id="3-4-字符串操作"><a href="#3-4-字符串操作" class="headerlink" title="3.4 字符串操作"></a>3.4 字符串操作</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282244617.png" alt="image.png"></p>
<p>UNICODE_STRING的初始化 ，常用的初始化函数为 RtlInitUnicodeString :</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSYSAPI VOID <span class="title">RtlInitUnicodeString</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PUNICODE_STRING         DestinationString,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] __drv_aliasesMem PCWSTR SourceString</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282246056.png" alt="image.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282247645.png" alt="image.png"></p>
<p>下面为读者介绍UNICODE_STRING的拷贝操作，拷贝操作可以使用 RtlUnicodeStringCopyString 函数，原型如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTRSAFEDDI <span class="title">RtlUnicodeStringCopyString</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [out] PUNICODE_STRING  DestinationString,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  NTSTRSAFE_PCWSTR pszSrc</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282248184.png" alt="image.png"></p>
<h3 id="练习点：字符串操作函数库"><a href="#练习点：字符串操作函数库" class="headerlink" title="练习点：字符串操作函数库"></a>练习点：字符串操作函数库</h3><p>在 C&#x2F;C++ 中，处理宽字符（<code>wchar_t</code>）的字符串操作函数主要定义在 <code>&lt;wchar.h&gt;</code>（C）或 <code>&lt;cwchar&gt;</code>（C++）头文件中。以下是常见的宽字符字符串操作函数及其功能：</p>
<hr>
<h4 id="1-基本字符串操作"><a href="#1-基本字符串操作" class="headerlink" title="1. 基本字符串操作"></a><strong>1. 基本字符串操作</strong></h4><table>
<thead>
<tr>
<th>函数</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>wcslen(const wchar_t *s)</code></td>
<td>返回宽字符串的长度（不包括终止符 <code>L&#39;\0&#39;</code>）。</td>
</tr>
<tr>
<td><code>wcscpy(wchar_t *dest, const wchar_t *src)</code></td>
<td>将 <code>src</code> 复制到 <code>dest</code>（需确保 <code>dest</code> 空间足够）。</td>
</tr>
<tr>
<td><code>wcsncpy(wchar_t *dest, const wchar_t *src, size_t n)</code></td>
<td>复制 <code>src</code> 的前 <code>n</code> 个字符到 <code>dest</code>，必要时截断或填充 <code>L&#39;\0&#39;</code>。</td>
</tr>
<tr>
<td><code>wcscat(wchar_t *dest, const wchar_t *src)</code></td>
<td>将 <code>src</code> 追加到 <code>dest</code> 末尾（需确保 <code>dest</code> 空间足够）。</td>
</tr>
<tr>
<td><code>wcsncat(wchar_t *dest, const wchar_t *src, size_t n)</code></td>
<td>追加 <code>src</code> 的前 <code>n</code> 个字符到 <code>dest</code>。</td>
</tr>
<tr>
<td><code>wcscmp(const wchar_t *s1, const wchar_t *s2)</code></td>
<td>比较 <code>s1</code> 和 <code>s2</code>，返回值为 0（相等）、正数（<code>s1 &gt; s2</code>）或负数（<code>s1 &lt; s2</code>）。</td>
</tr>
<tr>
<td><code>wcsncmp(const wchar_t *s1, const wchar_t *s2, size_t n)</code></td>
<td>比较前 <code>n</code> 个字符。</td>
</tr>
<tr>
<td><code>wcschr(const wchar_t *s, wchar_t c)</code></td>
<td>查找字符 <code>c</code> 在 <code>s</code> 中首次出现的位置，未找到返回 <code>NULL</code>。</td>
</tr>
<tr>
<td><code>wcsrchr(const wchar_t *s, wchar_t c)</code></td>
<td>查找字符 <code>c</code> 在 <code>s</code> 中最后一次出现的位置。</td>
</tr>
<tr>
<td><code>wcsstr(const wchar_t *haystack, const wchar_t *needle)</code></td>
<td>查找子串 <code>needle</code> 在 <code>haystack</code> 中的位置。</td>
</tr>
</tbody></table>
<hr>
<h4 id="2-内存与宽字符操作"><a href="#2-内存与宽字符操作" class="headerlink" title="2. 内存与宽字符操作"></a><strong>2. 内存与宽字符操作</strong></h4><table>
<thead>
<tr>
<th>函数</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>wmemcpy(wchar_t *dest, const wchar_t *src, size_t n)</code></td>
<td>从 <code>src</code> 复制 <code>n</code> 个宽字符到 <code>dest</code>。</td>
</tr>
<tr>
<td><code>wmemmove(wchar_t *dest, const wchar_t *src, size_t n)</code></td>
<td>安全地复制 <code>n</code> 个宽字符（处理内存重叠）。</td>
</tr>
<tr>
<td><code>wmemset(wchar_t *s, wchar_t c, size_t n)</code></td>
<td>将 <code>s</code> 的前 <code>n</code> 个宽字符设置为 <code>c</code>。</td>
</tr>
<tr>
<td><code>wmemcmp(const wchar_t *s1, const wchar_t *s2, size_t n)</code></td>
<td>比较 <code>s1</code> 和 <code>s2</code> 的前 <code>n</code> 个宽字符。</td>
</tr>
<tr>
<td><code>wmemchr(const wchar_t *s, wchar_t c, size_t n)</code></td>
<td>在 <code>s</code> 的前 <code>n</code> 个字符中查找 <code>c</code>。</td>
</tr>
</tbody></table>
<hr>
<h4 id="3-转换与格式化"><a href="#3-转换与格式化" class="headerlink" title="3. 转换与格式化"></a><strong>3. 转换与格式化</strong></h4><table>
<thead>
<tr>
<th>函数</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>swprintf(wchar_t *s, size_t n, const wchar_t *format, ...)</code></td>
<td>格式化输出到宽字符串（类似 <code>sprintf</code>）。</td>
</tr>
<tr>
<td><code>vswprintf(wchar_t *s, size_t n, const wchar_t *format, va_list arg)</code></td>
<td>可变参数版本的 <code>swprintf</code>。</td>
</tr>
<tr>
<td><code>wscanf</code>, <code>fwscanf</code>, <code>swscanf</code></td>
<td>从输入&#x2F;文件&#x2F;字符串读取格式化宽字符数据。</td>
</tr>
</tbody></table>
<hr>
<h4 id="4-多字节与宽字符转换"><a href="#4-多字节与宽字符转换" class="headerlink" title="4. 多字节与宽字符转换"></a><strong>4. 多字节与宽字符转换</strong></h4><table>
<thead>
<tr>
<th>函数</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>mbstowcs(wchar_t *dest, const char *src, size_t n)</code></td>
<td>多字节字符串 → 宽字符串。</td>
</tr>
<tr>
<td><code>wcstombs(char *dest, const wchar_t *src, size_t n)</code></td>
<td>宽字符串 → 多字节字符串。</td>
</tr>
<tr>
<td><code>mbrtowc(wchar_t *pwc, const char *s, size_t n, mbstate_t *ps)</code></td>
<td>多字节字符 → 宽字符（带状态）。</td>
</tr>
<tr>
<td><code>wcrtomb(char *s, wchar_t wc, mbstate_t *ps)</code></td>
<td>宽字符 → 多字节字符（带状态）。</td>
</tr>
</tbody></table>
<hr>
<h4 id="5-其他工具函数"><a href="#5-其他工具函数" class="headerlink" title="5. 其他工具函数"></a><strong>5. 其他工具函数</strong></h4><table>
<thead>
<tr>
<th>函数</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>wcstok(wchar_t *s, const wchar_t *delim, wchar_t **ptr)</code></td>
<td>分割宽字符串（线程安全版本，类似 <code>strtok</code>）。</td>
</tr>
<tr>
<td><code>wcscoll(const wchar_t *s1, const wchar_t *s2)</code></td>
<td>根据本地化规则比较字符串（用于排序）。</td>
</tr>
<tr>
<td><code>wcsxfrm(wchar_t *dest, const wchar_t *src, size_t n)</code></td>
<td>转换字符串为可比较形式（用于本地化排序）。</td>
</tr>
</tbody></table>
<hr>
<h4 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;locale.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    setlocale(LC_ALL, <span class="string">&quot;&quot;</span>); <span class="comment">// 启用本地化支持</span></span><br><span class="line">    <span class="type">wchar_t</span> str1[<span class="number">20</span>] = <span class="string">L&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="type">wchar_t</span> str2[] = <span class="string">L&quot; 世界&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    wcscat(str1, str2); <span class="comment">// 拼接宽字符串</span></span><br><span class="line">    wprintf(<span class="string">L&quot;结果: %ls\n&quot;</span>, str1); <span class="comment">// 输出: &quot;Hello 世界&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a><strong>注意事项</strong></h4><ol>
<li><strong>宽字符常量</strong>：使用 <code>L</code> 前缀（如 <code>L&quot;宽字符串&quot;</code>）。</li>
<li><strong>本地化设置</strong>：调用 <code>setlocale(LC_ALL, &quot;&quot;)</code> 以确保多字节&#x2F;宽字符转换正确。</li>
<li><strong>安全性</strong>：优先使用带 <code>n</code> 的限制长度函数（如 <code>wcsncpy</code> 而非 <code>wcscpy</code>）避免缓冲区溢出。</li>
</ol>
<h2 id="3-5-链表"><a href="#3-5-链表" class="headerlink" title="3.5 链表"></a>3.5 链表</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282251841.png" alt="image.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282251030.png" alt="image.png"></p>
<h3 id="3-5-1-头节点初始化"><a href="#3-5-1-头节点初始化" class="headerlink" title="3.5.1 头节点初始化"></a>3.5.1 头节点初始化</h3><p>InitializeListHead</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">InitializeListHead</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [out] PLIST_ENTRY ListHead</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>


<h3 id="3-5-2-节点插入"><a href="#3-5-2-节点插入" class="headerlink" title="3.5.2 节点插入"></a>3.5.2 节点插入</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">InsertHeadList</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] PLIST_ENTRY                  ListHead,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] __drv_aliasesMem PLIST_ENTRY Entry</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">InsertTailList</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] PLIST_ENTRY                  ListHead,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] __drv_aliasesMem PLIST_ENTRY Entry</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>


<h3 id="3-5-3-链表遍历"><a href="#3-5-3-链表遍历" class="headerlink" title="3.5.3 链表遍历"></a>3.5.3 链表遍历</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282305047.png" alt="image.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282306986.png" alt="image.png"></p>
<h3 id="思考点：windbg时怎么打印？"><a href="#思考点：windbg时怎么打印？" class="headerlink" title="思考点：windbg时怎么打印？"></a>思考点：windbg时怎么打印？</h3><p>LIST_ENTRY不在结构体头部，如何快速便利整条链表？</p>
<p>windbg 查看时链表结构</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202506082307949.png" alt="image.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202506082310940.png" alt="image.png"></p>
<h3 id="3-5-4-节点移除"><a href="#3-5-4-节点移除" class="headerlink" title="3.5.4 节点移除"></a>3.5.4 节点移除</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PLIST_ENTRY <span class="title">RemoveHeadList</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] PLIST_ENTRY ListHead</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">PLIST_ENTRY <span class="title">RemoveTailList</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] PLIST_ENTRY ListHead</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">RemoveEntryList</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PLIST_ENTRY Entry</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">IsListEmpty</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">const</span> LIST_ENTRY *ListHead</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>


<h3 id="注意点：锁中不建议释放内存"><a href="#注意点：锁中不建议释放内存" class="headerlink" title="注意点：锁中不建议释放内存"></a>注意点：锁中不建议释放内存</h3><h2 id="3-6-自旋锁"><a href="#3-6-自旋锁" class="headerlink" title="3.6 自旋锁"></a>3.6 自旋锁</h2><h3 id="3-6-1-使用自旋锁"><a href="#3-6-1-使用自旋锁" class="headerlink" title="3.6.1 使用自旋锁"></a>3.6.1 使用自旋锁</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282310991.png" alt="image.png"></p>
<p>初始化获取一个自旋锁</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">KSPIN_LOCK my_spin_lock;</span><br><span class="line"><span class="built_in">KeInitializeSpinLock</span>(&amp;my_spin_lock);</span><br></pre></td></tr></table></figure>

<p>使用自旋锁</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">KeAcquireSpinLock</span></span><br><span class="line"><span class="attribute">KeReleaseSpinLock</span></span><br></pre></td></tr></table></figure>

<h3 id="注意点-锁一般不使用局部变量"><a href="#注意点-锁一般不使用局部变量" class="headerlink" title="注意点: 锁一般不使用局部变量"></a>注意点: 锁一般不使用局部变量</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282329364.png" alt="image.png"></p>
<h3 id="3-6-2-在双向链表中使用自旋锁"><a href="#3-6-2-在双向链表中使用自旋锁" class="headerlink" title="3.6.2 在双向链表中使用自旋锁"></a>3.6.2 在双向链表中使用自旋锁</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ExInterlockedInsertHeadList</span></span><br></pre></td></tr></table></figure>




<h3 id="3-6-3-使用队列自旋锁提高性能"><a href="#3-6-3-使用队列自旋锁提高性能" class="headerlink" title="3.6.3 使用队列自旋锁提高性能"></a>3.6.3 使用队列自旋锁提高性能</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282332162.png" alt="image.png"></p>
<p>队列自旋锁的使用和普通自旋锁的使用方法基本一样，初始化自旋锁也是使用KeInitializeSpinLock函数，唯一不同的地方是在获取和释放自旋锁时需要使用新的函数：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">KeInitializeSpinLock</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282332842.png" alt="image.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282333621.png" alt="image.png"></p>
<h2 id="3-7-内存分配"><a href="#3-7-内存分配" class="headerlink" title="3.7 内存分配"></a>3.7 内存分配</h2><h3 id="3-7-1-常规内存分配"><a href="#3-7-1-常规内存分配" class="headerlink" title="3.7.1 常规内存分配"></a>3.7.1 常规内存分配</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282335369.png" alt="image.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282336140.png" alt="image.png"></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ExAllocatePoolWithTag</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">ExFreePoolWithTag</span></span><br></pre></td></tr></table></figure>


<h3 id="3-7-2-旁视列表"><a href="#3-7-2-旁视列表" class="headerlink" title="3.7.2 旁视列表"></a>3.7.2 旁视列表</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282337371.png" alt="image.png"></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ExInitializeNPagedLookasideList</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">ExAllocateFromNPagedLookasideList</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">ExDeleteNPagedLookasideList</span></span><br></pre></td></tr></table></figure>


<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282342029.png" alt="image.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282342677.png" alt="image.png"></p>
<h3 id="练习点-旁氏列表"><a href="#练习点-旁氏列表" class="headerlink" title="练习点:旁氏列表"></a>练习点:旁氏列表</h3><blockquote>
<p>相同的大小的结构体的开辟使用一个旁氏列表就够了,笔者曾经犯过 A B 两条链表都是相同的结构体,但是用了两条旁氏列表的错误</p>
</blockquote>
<h2 id="3-8-对象与句柄"><a href="#3-8-对象与句柄" class="headerlink" title="3.8 对象与句柄"></a>3.8 对象与句柄</h2><h3 id="对象与句柄"><a href="#对象与句柄" class="headerlink" title="对象与句柄"></a>对象与句柄</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282346736.png" alt="image.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282348348.png" alt="image.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282349293.png" alt="image.png"></p>
<h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数:"></a>引用计数:</h3><h3 id="问题点-指针计数如何独立增加与减少"><a href="#问题点-指针计数如何独立增加与减少" class="headerlink" title="问题点:指针计数如何独立增加与减少?"></a>问题点:指针计数如何独立增加与减少?</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505282351080.png" alt="image.png"></p>
<h3 id="练习点-CreateEvent-观察句柄值与对象"><a href="#练习点-CreateEvent-观察句柄值与对象" class="headerlink" title="练习点: CreateEvent 观察句柄值与对象"></a>练习点: CreateEvent 观察句柄值与对象</h3><h2 id="3-9-注册表"><a href="#3-9-注册表" class="headerlink" title="3.9 注册表"></a>3.9 注册表</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292245714.png" alt="image.png"></p>
<h3 id="3-9-1-注册表的打开与关闭"><a href="#3-9-1-注册表的打开与关闭" class="headerlink" title="3.9.1 注册表的打开与关闭"></a>3.9.1 注册表的打开与关闭</h3><h3 id="ZwCreateKey"><a href="#ZwCreateKey" class="headerlink" title="ZwCreateKey"></a>ZwCreateKey</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292246724.png" alt="image.png"></p>
<h3 id="3-9-2-注册表的修改"><a href="#3-9-2-注册表的修改" class="headerlink" title="3.9.2 注册表的修改"></a>3.9.2 注册表的修改</h3><p>ZwSetValueKey</p>
<h3 id="3-9-3-注册表的读取"><a href="#3-9-3-注册表的读取" class="headerlink" title="3.9.3 注册表的读取"></a>3.9.3 注册表的读取</h3><p>ZwQueryValueKey</p>
<h2 id="练习点：封装注册表操作函数"><a href="#练习点：封装注册表操作函数" class="headerlink" title="练习点：封装注册表操作函数"></a>练习点：封装注册表操作函数</h2><h2 id="3-10-文件操作"><a href="#3-10-文件操作" class="headerlink" title="3.10 文件操作"></a>3.10 文件操作</h2><p>3.10.1 文件的打开与关闭</p>
<p>ZwCreateFile</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292253502.png" alt="image.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292249560.png" alt="image.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292249833.png" alt="image.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292250201.png" alt="image.png"></p>
<h3 id="补充点：ShareAccess-参数有做过对独占的判断"><a href="#补充点：ShareAccess-参数有做过对独占的判断" class="headerlink" title="补充点：ShareAccess 参数有做过对独占的判断"></a>补充点：ShareAccess 参数有做过对独占的判断</h3><p>修改 IRP 时需要调用一个函数：</p>
<h3 id="3-10-2-文件的读写"><a href="#3-10-2-文件的读写" class="headerlink" title="3.10.2 文件的读写"></a>3.10.2 文件的读写</h3><p>ZwReadFile</p>
<p>ZwWriteFile</p>
<h2 id="3-11-线程与事件"><a href="#3-11-线程与事件" class="headerlink" title="3.11 线程与事件"></a>3.11 线程与事件</h2><h3 id="3-11-1-使用系统线程"><a href="#3-11-1-使用系统线程" class="headerlink" title="3.11.1 使用系统线程"></a>3.11.1 使用系统线程</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292255234.png" alt="image.png"></p>
<p>PsCreateSystemThread</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292257839.png" alt="image.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292257097.png" alt="image.png"></p>
<p>CustomThreadProc</p>
<p>PsTerminateSystemThread</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292258922.png" alt="image.png"></p>
<h3 id="3-11-2-使用同步事件"><a href="#3-11-2-使用同步事件" class="headerlink" title="3.11.2 使用同步事件"></a>3.11.2 使用同步事件</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292259512.png" alt="image.png"></p>
<p>KeInitlizeEvent</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292300061.png" alt="image.png"></p>
<p>KeSetEvent</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292300544.png" alt="image.png"></p>
<p>KeResetEvent</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gcmz925-note.oss-cn-shenzhen.aliyuncs.com/gcmz/note202505292305088.png" alt="image.png"></p>
<p>通俗一点讲，也就是同步事件在处理完后，会自动设置无信号状态，下次会继续等待<br>通告事件，会一直开绿灯，直到调用 KeResetEvent 重新设置为无信号状态</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">Gcmz</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC3%E7%AB%A0%20%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC3%E7%AB%A0%20%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/')">第3章 内核编程基础</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC3%E7%AB%A0%20%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=第3章 内核编程基础&amp;url=http://example.com/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC3%E7%AB%A0%20%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Gcmz Blog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B-%E8%B0%AD%E6%96%87-%E9%99%88%E9%93%AD%E9%9C%96-%E8%91%97/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>Windows内核编程(谭文 陈铭霖 著)<span class="categoryesPageCount">6</span></a><a class="post-meta__box__categoryes" href="/categories/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B-%E8%B0%AD%E6%96%87-%E9%99%88%E9%93%AD%E9%9C%96-%E8%91%97/%E5%AD%A6%E4%B9%A0/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>学习<span class="categoryesPageCount">6</span></a></div><div class="post-meta__box__tag-list"></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC2%E7%AB%A0%20%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E8%BF%90%E8%A1%8C%E4%B8%8E%E8%B0%83%E8%AF%95/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">第2章 内核驱动运行与调试</div></div></a></div><div class="next-post pull-right"><a href="/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC4%E7%AB%A0%20%E5%BA%94%E7%94%A8%E4%B8%8E%E5%86%85%E6%A0%B8%E9%80%9A%E4%BF%A1/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">第4章 应用与内核通信</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description"></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">3.1 上下文环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82%E7%BA%A7%E5%88%AB"><span class="toc-number">2.</span> <span class="toc-text">3.2 中断请求级别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E9%A9%B1%E5%8A%A8%E5%BC%82%E5%B8%B8"><span class="toc-number">3.</span> <span class="toc-text">3.3 驱动异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C"><span class="toc-number">4.</span> <span class="toc-text">3.4 字符串操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0%E7%82%B9%EF%BC%9A%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0%E5%BA%93"><span class="toc-number">4.1.</span> <span class="toc-text">练习点：字符串操作函数库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C"><span class="toc-number">4.1.1.</span> <span class="toc-text">1. 基本字符串操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%86%85%E5%AD%98%E4%B8%8E%E5%AE%BD%E5%AD%97%E7%AC%A6%E6%93%8D%E4%BD%9C"><span class="toc-number">4.1.2.</span> <span class="toc-text">2. 内存与宽字符操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%BD%AC%E6%8D%A2%E4%B8%8E%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="toc-number">4.1.3.</span> <span class="toc-text">3. 转换与格式化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%A4%9A%E5%AD%97%E8%8A%82%E4%B8%8E%E5%AE%BD%E5%AD%97%E7%AC%A6%E8%BD%AC%E6%8D%A2"><span class="toc-number">4.1.4.</span> <span class="toc-text">4. 多字节与宽字符转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0"><span class="toc-number">4.1.5.</span> <span class="toc-text">5. 其他工具函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">4.1.6.</span> <span class="toc-text">示例代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">4.1.7.</span> <span class="toc-text">注意事项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E9%93%BE%E8%A1%A8"><span class="toc-number">5.</span> <span class="toc-text">3.5 链表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-%E5%A4%B4%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">5.1.</span> <span class="toc-text">3.5.1 头节点初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-%E8%8A%82%E7%82%B9%E6%8F%92%E5%85%A5"><span class="toc-number">5.2.</span> <span class="toc-text">3.5.2 节点插入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-3-%E9%93%BE%E8%A1%A8%E9%81%8D%E5%8E%86"><span class="toc-number">5.3.</span> <span class="toc-text">3.5.3 链表遍历</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E7%82%B9%EF%BC%9Awindbg%E6%97%B6%E6%80%8E%E4%B9%88%E6%89%93%E5%8D%B0%EF%BC%9F"><span class="toc-number">5.4.</span> <span class="toc-text">思考点：windbg时怎么打印？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-4-%E8%8A%82%E7%82%B9%E7%A7%BB%E9%99%A4"><span class="toc-number">5.5.</span> <span class="toc-text">3.5.4 节点移除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9%EF%BC%9A%E9%94%81%E4%B8%AD%E4%B8%8D%E5%BB%BA%E8%AE%AE%E9%87%8A%E6%94%BE%E5%86%85%E5%AD%98"><span class="toc-number">5.6.</span> <span class="toc-text">注意点：锁中不建议释放内存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-%E8%87%AA%E6%97%8B%E9%94%81"><span class="toc-number">6.</span> <span class="toc-text">3.6 自旋锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-1-%E4%BD%BF%E7%94%A8%E8%87%AA%E6%97%8B%E9%94%81"><span class="toc-number">6.1.</span> <span class="toc-text">3.6.1 使用自旋锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9-%E9%94%81%E4%B8%80%E8%88%AC%E4%B8%8D%E4%BD%BF%E7%94%A8%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="toc-number">6.2.</span> <span class="toc-text">注意点: 锁一般不使用局部变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-2-%E5%9C%A8%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%87%AA%E6%97%8B%E9%94%81"><span class="toc-number">6.3.</span> <span class="toc-text">3.6.2 在双向链表中使用自旋锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-3-%E4%BD%BF%E7%94%A8%E9%98%9F%E5%88%97%E8%87%AA%E6%97%8B%E9%94%81%E6%8F%90%E9%AB%98%E6%80%A7%E8%83%BD"><span class="toc-number">6.4.</span> <span class="toc-text">3.6.3 使用队列自旋锁提高性能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D"><span class="toc-number">7.</span> <span class="toc-text">3.7 内存分配</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-1-%E5%B8%B8%E8%A7%84%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D"><span class="toc-number">7.1.</span> <span class="toc-text">3.7.1 常规内存分配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-2-%E6%97%81%E8%A7%86%E5%88%97%E8%A1%A8"><span class="toc-number">7.2.</span> <span class="toc-text">3.7.2 旁视列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0%E7%82%B9-%E6%97%81%E6%B0%8F%E5%88%97%E8%A1%A8"><span class="toc-number">7.3.</span> <span class="toc-text">练习点:旁氏列表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%8F%A5%E6%9F%84"><span class="toc-number">8.</span> <span class="toc-text">3.8 对象与句柄</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%8F%A5%E6%9F%84"><span class="toc-number">8.1.</span> <span class="toc-text">对象与句柄</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0"><span class="toc-number">8.2.</span> <span class="toc-text">引用计数:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E7%82%B9-%E6%8C%87%E9%92%88%E8%AE%A1%E6%95%B0%E5%A6%82%E4%BD%95%E7%8B%AC%E7%AB%8B%E5%A2%9E%E5%8A%A0%E4%B8%8E%E5%87%8F%E5%B0%91"><span class="toc-number">8.3.</span> <span class="toc-text">问题点:指针计数如何独立增加与减少?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0%E7%82%B9-CreateEvent-%E8%A7%82%E5%AF%9F%E5%8F%A5%E6%9F%84%E5%80%BC%E4%B8%8E%E5%AF%B9%E8%B1%A1"><span class="toc-number">8.4.</span> <span class="toc-text">练习点: CreateEvent 观察句柄值与对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9-%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="toc-number">9.</span> <span class="toc-text">3.9 注册表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-1-%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%9A%84%E6%89%93%E5%BC%80%E4%B8%8E%E5%85%B3%E9%97%AD"><span class="toc-number">9.1.</span> <span class="toc-text">3.9.1 注册表的打开与关闭</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZwCreateKey"><span class="toc-number">9.2.</span> <span class="toc-text">ZwCreateKey</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-2-%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="toc-number">9.3.</span> <span class="toc-text">3.9.2 注册表的修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-3-%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%9A%84%E8%AF%BB%E5%8F%96"><span class="toc-number">9.4.</span> <span class="toc-text">3.9.3 注册表的读取</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0%E7%82%B9%EF%BC%9A%E5%B0%81%E8%A3%85%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0"><span class="toc-number">10.</span> <span class="toc-text">练习点：封装注册表操作函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-10-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">11.</span> <span class="toc-text">3.10 文件操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E7%82%B9%EF%BC%9AShareAccess-%E5%8F%82%E6%95%B0%E6%9C%89%E5%81%9A%E8%BF%87%E5%AF%B9%E7%8B%AC%E5%8D%A0%E7%9A%84%E5%88%A4%E6%96%AD"><span class="toc-number">11.1.</span> <span class="toc-text">补充点：ShareAccess 参数有做过对独占的判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-10-2-%E6%96%87%E4%BB%B6%E7%9A%84%E8%AF%BB%E5%86%99"><span class="toc-number">11.2.</span> <span class="toc-text">3.10.2 文件的读写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-11-%E7%BA%BF%E7%A8%8B%E4%B8%8E%E4%BA%8B%E4%BB%B6"><span class="toc-number">12.</span> <span class="toc-text">3.11 线程与事件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-11-1-%E4%BD%BF%E7%94%A8%E7%B3%BB%E7%BB%9F%E7%BA%BF%E7%A8%8B"><span class="toc-number">12.1.</span> <span class="toc-text">3.11.1 使用系统线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-11-2-%E4%BD%BF%E7%94%A8%E5%90%8C%E6%AD%A5%E4%BA%8B%E4%BB%B6"><span class="toc-number">12.2.</span> <span class="toc-text">3.11.2 使用同步事件</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/24/%E5%91%BD%E5%90%8D/" title="命名">命名</a><time datetime="2025-07-24T15:54:19.271Z" title="发表于 2025-07-24 23:54:19">2025-07-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC6%E7%AB%A0%20%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" title="第6章 内核编程技巧">第6章 内核编程技巧</a><time datetime="2025-07-23T15:19:12.164Z" title="发表于 2025-07-23 23:19:12">2025-07-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC5%E7%AB%A0%2064%E4%BD%8D%E5%92%8C32%E4%BD%8D%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E5%B7%AE%E5%BC%82/" title="第5章 64位和32位内核开发差异">第5章 64位和32位内核开发差异</a><time datetime="2025-07-23T15:19:12.139Z" title="发表于 2025-07-23 23:19:12">2025-07-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC4%E7%AB%A0%20%E5%BA%94%E7%94%A8%E4%B8%8E%E5%86%85%E6%A0%B8%E9%80%9A%E4%BF%A1/" title="第4章 应用与内核通信">第4章 应用与内核通信</a><time datetime="2025-07-23T15:19:12.117Z" title="发表于 2025-07-23 23:19:12">2025-07-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/23/%E5%AD%A6%E4%B9%A0/Windows%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B(%E8%B0%AD%E6%96%87%20%E9%99%88%E9%93%AD%E9%9C%96%20%E8%91%97)/%E7%AC%AC3%E7%AB%A0%20%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" title="第3章 内核编程基础">第3章 内核编程基础</a><time datetime="2025-07-23T15:19:12.106Z" title="发表于 2025-07-23 23:19:12">2025-07-23</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="Gcmz" target="_blank">Gcmz</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">46</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">26</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("25/12/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Gcmz 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>