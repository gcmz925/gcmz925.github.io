<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="bash 脚本中关于时间的运用1234567891011121314151617181920212223242526272829303132333435363738394041424344454647@echo offREM 记录当前开始时间set start_time&#x3D;%time%echo Start time: %start_time%REM 模拟某些操作，例如等待 5 秒（这里可以替换成其他">
<meta property="og:type" content="article">
<meta property="og:title" content="bash 脚本中关于时间的运用">
<meta property="og:url" content="http://example.com/2025/04/06/shell/shell%20%E5%85%B3%E4%BA%8E%E6%97%B6%E9%97%B4%E7%9A%84%E8%BF%90%E7%94%A8/index.html">
<meta property="og:site_name" content="Gcmz Blog">
<meta property="og:description" content="bash 脚本中关于时间的运用1234567891011121314151617181920212223242526272829303132333435363738394041424344454647@echo offREM 记录当前开始时间set start_time&#x3D;%time%echo Start time: %start_time%REM 模拟某些操作，例如等待 5 秒（这里可以替换成其他">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-04-06T09:03:33.157Z">
<meta property="article:modified_time" content="2025-04-06T10:08:47.446Z">
<meta property="article:author" content="Gcmz">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2025/04/06/shell/shell%20%E5%85%B3%E4%BA%8E%E6%97%B6%E9%97%B4%E7%9A%84%E8%BF%90%E7%94%A8/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/04/06/shell/shell%20%E5%85%B3%E4%BA%8E%E6%97%B6%E9%97%B4%E7%9A%84%E8%BF%90%E7%94%A8/","path":"2025/04/06/shell/shell 关于时间的运用/","title":"bash 脚本中关于时间的运用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>bash 脚本中关于时间的运用 | Gcmz Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Gcmz Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#bash-%E8%84%9A%E6%9C%AC%E4%B8%AD%E5%85%B3%E4%BA%8E%E6%97%B6%E9%97%B4%E7%9A%84%E8%BF%90%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">bash 脚本中关于时间的运用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">1.1.</span> <span class="nav-text">代码解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE-%E8%AE%BE%E7%BD%AE%E4%B8%A4%E6%AC%A1%E5%8E%9F%E5%9B%A0"><span class="nav-number">1.2.</span> <span class="nav-text">问:设置两次原因</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%8C%E6%99%AF%E4%B8%8E%E5%8E%9F%E5%9B%A0"><span class="nav-number">1.3.</span> <span class="nav-text">背景与原因</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E5%8E%9F%E5%9B%A0"><span class="nav-number">1.4.</span> <span class="nav-text">具体原因</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE-%E8%BF%90%E7%AE%97%E7%BB%93%E6%9E%9C%E4%B8%8D%E7%AC%A6"><span class="nav-number">1.5.</span> <span class="nav-text">问:运算结果不符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E7%8E%B0%E8%B1%A1"><span class="nav-number">1.6.</span> <span class="nav-text">问题现象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="nav-number">1.7.</span> <span class="nav-text">原因分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="nav-number">1.8.</span> <span class="nav-text">解决方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95-1%EF%BC%9A%E9%80%9A%E8%BF%87-setlocal-%E4%B8%AD%E7%9A%84%E4%B8%B4%E6%97%B6%E5%8F%98%E9%87%8F%E4%BC%A0%E9%80%92%E5%80%BC"><span class="nav-number">1.9.</span> <span class="nav-text">方法 1：通过 setlocal 中的临时变量传递值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90"><span class="nav-number">1.10.</span> <span class="nav-text">解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95-2%EF%BC%9A%E4%BD%BF%E7%94%A8-setlocal-%E5%92%8C-endlocal-%E5%90%8C%E6%97%B6%E4%BC%A0%E9%80%92%E5%A4%9A%E4%B8%AA%E5%8F%98%E9%87%8F"><span class="nav-number">1.11.</span> <span class="nav-text">方法 2：使用 setlocal 和 endlocal 同时传递多个变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90-1"><span class="nav-number">1.12.</span> <span class="nav-text">解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95-3%EF%BC%9A%E4%BD%BF%E7%94%A8-call-%E4%BC%A0%E9%80%92%E8%AE%A1%E7%AE%97%E7%BB%93%E6%9E%9C"><span class="nav-number">1.13.</span> <span class="nav-text">方法 3：使用 call 传递计算结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90-2"><span class="nav-number">1.14.</span> <span class="nav-text">解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.15.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BE%E4%BE%8B"><span class="nav-number">1.16.</span> <span class="nav-text">修改举例:</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Gcmz</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/06/shell/shell%20%E5%85%B3%E4%BA%8E%E6%97%B6%E9%97%B4%E7%9A%84%E8%BF%90%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Gcmz">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Gcmz Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="bash 脚本中关于时间的运用 | Gcmz Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          bash 脚本中关于时间的运用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-04-06 17:03:33 / 修改时间：18:08:47" itemprop="dateCreated datePublished" datetime="2025-04-06T17:03:33+08:00">2025-04-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/shell/" itemprop="url" rel="index"><span itemprop="name">shell</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="bash-脚本中关于时间的运用"><a href="#bash-脚本中关于时间的运用" class="headerlink" title="bash 脚本中关于时间的运用"></a>bash 脚本中关于时间的运用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">REM 记录当前开始时间</span><br><span class="line"><span class="built_in">set</span> start_time=%<span class="keyword">time</span>%</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Start <span class="keyword">time</span>: %start_time%</span><br><span class="line">REM 模拟某些操作，例如等待 5 秒（这里可以替换成其他操作）</span><br><span class="line"><span class="built_in">timeout</span> /t 5 &gt; nul</span><br><span class="line"></span><br><span class="line">REM 记录结束时间</span><br><span class="line"><span class="built_in">set</span> end_time=%<span class="keyword">time</span>%</span><br><span class="line"><span class="built_in">echo</span> End <span class="keyword">time</span>: %end_time%</span><br><span class="line"></span><br><span class="line">REM 将开始和结束时间转换为秒数</span><br><span class="line">call :TimeToSeconds start_seconds %start_time%</span><br><span class="line">call :TimeToSeconds end_seconds %end_time%</span><br><span class="line"></span><br><span class="line">REM 计算时间差（秒）</span><br><span class="line"><span class="built_in">set</span> /a elapsed_seconds=%end_seconds%-%start_seconds%</span><br><span class="line"></span><br><span class="line">REM 如果时间差为负值（表示跨天了），则加上 86400 秒 (24 小时)</span><br><span class="line"><span class="keyword">if</span> %elapsed_seconds% lss 0 <span class="built_in">set</span> /a elapsed_seconds+=86400</span><br><span class="line"></span><br><span class="line">REM 将时间差转换回时:分:秒格式</span><br><span class="line">call :FormatElapsedTime %elapsed_seconds%</span><br><span class="line"></span><br><span class="line">pause</span><br><span class="line"><span class="built_in">exit</span> /b</span><br><span class="line"></span><br><span class="line">REM 函数：将 HH:MM:SS 时间格式转换为秒数</span><br><span class="line">:TimeToSeconds</span><br><span class="line">setlocal</span><br><span class="line"><span class="built_in">set</span> time_string=%~2</span><br><span class="line"><span class="built_in">set</span> /a hours=1%time_string:~0,2% - 100</span><br><span class="line"><span class="built_in">set</span> /a minutes=1%time_string:~3,2% - 100</span><br><span class="line"><span class="built_in">set</span> /a seconds=1%time_string:~6,2% - 100</span><br><span class="line"><span class="built_in">set</span> /a %1=hours*3600 + minutes*60 + seconds</span><br><span class="line">endlocal &amp; <span class="built_in">set</span> %1=%hours% * 3600 + %minutes% * 60 + %seconds%</span><br><span class="line"><span class="built_in">exit</span> /b</span><br><span class="line"></span><br><span class="line">REM 函数：将秒数转换为时:分:秒格式输出</span><br><span class="line">:FormatElapsedTime</span><br><span class="line">setlocal</span><br><span class="line"><span class="built_in">set</span> /a seconds=%1, minutes=seconds/60, hours=minutes/60</span><br><span class="line"><span class="built_in">set</span> /a seconds=seconds%%60, minutes=minutes%%60</span><br><span class="line"><span class="built_in">echo</span> Elapsed Time: %hours% hour(s), %minutes% minute(s), %seconds% second(s)</span><br><span class="line"><span class="built_in">exit</span> /b</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这些语句是用于将时间字符串中的小时、分钟和秒提取出来，并转换为整数表示。具体解释如下：</p>
<h3 id="代码解析"><a href="#代码解析" class="headerlink" title="代码解析"></a>代码解析</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">REM 函数：将 HH:MM:SS 时间格式转换为秒数</span></span><br><span class="line">:TimeToSeconds</span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line"><span class="built_in">set</span> time_string=%~<span class="number">2</span></span><br><span class="line"><span class="built_in">set</span> /a hours=<span class="number">1</span><span class="variable">%time_string:~0,2%</span> - <span class="number">100</span></span><br><span class="line"><span class="built_in">set</span> /a minutes=<span class="number">1</span><span class="variable">%time_string:~3,2%</span> - <span class="number">100</span></span><br><span class="line"><span class="built_in">set</span> /a seconds=<span class="number">1</span><span class="variable">%time_string:~6,2%</span> - <span class="number">100</span></span><br><span class="line"><span class="built_in">set</span> /a %<span class="number">1</span>=hours*<span class="number">3600</span> + minutes*<span class="number">60</span> + seconds</span><br><span class="line"><span class="built_in">endlocal</span> &amp; <span class="built_in">set</span> <span class="variable">%1=%</span>hours% * <span class="number">3600</span> + <span class="variable">%minutes%</span> * <span class="number">60</span> + <span class="variable">%seconds%</span></span><br><span class="line"><span class="keyword">exit</span> /b</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong><code>set time_string=%~2</code></strong>:</p>
<ul>
<li><code>set time_string=%~2</code> 语句将传递给当前批处理脚本的第二个参数（<code>%2</code>）赋值给变量 <code>time_string</code>。<code>%~2</code> 表示去除参数 <code>%2</code> 可能包含的引号。</li>
</ul>
</li>
</ol>
<ul>
<li>例如，如果批处理脚本被调用为 <code>myScript.bat &quot;12:34:56&quot; 15:43:21</code>，那么 <code>%2</code> 对应的值就是 <code>15:43:21</code>，<code>time_string</code> 变量的值将被设置为 <code>15:43:21</code>。</li>
</ul>
<ol start="2">
<li><p><strong><code>set /a hours=1%time_string:~0,2% - 100</code></strong>:</p>
<ul>
<li>这一行从 <code>time_string</code> 中提取 <code>0</code> 到 <code>2</code> 的字符（即小时部分），并将其转换为整数：<ul>
<li><code>time_string:~0,2</code> 提取了 <code>time_string</code> 中从索引 <code>0</code> 开始的两个字符，表示小时数（假设 <code>time_string</code> 为 <code>15:43:21</code>，则提取结果为 <code>15</code>）。</li>
<li><code>1%time_string:~0,2%</code> 在前面加了一个 <code>1</code>，避免批处理将 <code>08</code> 和 <code>09</code> 这样的数字视为八进制。</li>
<li><code>- 100</code> 用来去除多加的 <code>1</code>。比如 <code>115 - 100 = 15</code>，<code>08</code> 会变成 <code>108 - 100 = 8</code>，这样处理后就得到了小时数的整数表示。</li>
</ul>
</li>
<li>最终，<code>hours</code> 变量会被赋值为整数形式的小时数。</li>
</ul>
</li>
<li><p><strong><code>set /a minutes=1%time_string:~3,2% - 100</code></strong>:</p>
<ul>
<li>这一行从 <code>time_string</code> 中提取 <code>3</code> 到 <code>5</code> 的字符（即分钟部分），并将其转换为整数：<ul>
<li><code>time_string:~3,2</code> 提取了分钟部分，比如 <code>15:43:21</code> 的分钟部分是 <code>43</code>。</li>
<li>同样在前面加 <code>1</code>，然后再减 <code>100</code> 来去除前导 <code>1</code>。</li>
</ul>
</li>
<li>最终，<code>minutes</code> 变量会被赋值为整数形式的分钟数。</li>
</ul>
</li>
<li><p><strong><code>set /a seconds=1%time_string:~6,2% - 100</code></strong>:</p>
<ul>
<li>这一行从 <code>time_string</code> 中提取 <code>6</code> 到 <code>8</code> 的字符（即秒部分），并将其转换为整数：<ul>
<li><code>time_string:~6,2</code> 提取了秒数部分，比如 <code>15:43:21</code> 的秒部分是 <code>21</code>。</li>
<li>同样在前面加 <code>1</code>，然后再减 <code>100</code> 来去除前导 <code>1</code>。</li>
</ul>
</li>
</ul>
</li>
</ol>
<ul>
<li>最终，<code>seconds</code> 变量会被赋值为整数形式的秒数。</li>
</ul>
<ol start="5">
<li><p><strong><code>set /a %1=hours*3600 + minutes*60 + seconds</code></strong>:</p>
<ul>
<li>这一行将提取的小时、分钟和秒数转换为总秒数，并赋值给传递给批处理脚本的第一个参数（<code>%1</code>）。</li>
<li>例如，如果 <code>hours=15</code>，<code>minutes=43</code>，<code>seconds=21</code>，则计算的总秒数为：<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> /a %<span class="number">1</span>=<span class="number">15</span>*<span class="number">3600</span> + <span class="number">43</span>*<span class="number">60</span> + <span class="number">21</span></span><br></pre></td></tr></table></figure>

计算结果为 <code>56580 + 2580 + 21 = 59181</code>，最终 <code>59181</code> 秒会被赋值给 <code>%1</code> 所指向的变量（假设 <code>%1</code> 对应的变量名是 <code>elapsed_seconds</code>，那么 <code>elapsed_seconds</code> 就会被赋值为 <code>59181</code>）。</li>
</ul>
</li>
</ol>
<h3 id="问-设置两次原因"><a href="#问-设置两次原因" class="headerlink" title="问:设置两次原因"></a>问:设置两次原因</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> /a %<span class="number">1</span>=hours*<span class="number">3600</span> + minutes*<span class="number">60</span> + seconds</span><br><span class="line"><span class="built_in">endlocal</span> &amp; <span class="built_in">set</span> <span class="variable">%1=%</span>hours% * <span class="number">3600</span> + <span class="variable">%minutes%</span> * <span class="number">60</span> + <span class="variable">%seconds%</span></span><br></pre></td></tr></table></figure>

<blockquote>
<h3 id="背景与原因"><a href="#背景与原因" class="headerlink" title="背景与原因"></a>背景与原因</h3><p>在批处理脚本中，<code>setlocal</code> 和 <code>endlocal</code> 用于创建和销毁局部变量作用域。也就是说，任何在 <code>setlocal</code> 和 <code>endlocal</code> 之间创建或修改的变量，都会在 <code>endlocal</code> 执行之后失效，返回到 <code>setlocal</code> 之前的状态。这使得它们非常适合防止变量污染全局环境。</p>
<h3 id="具体原因"><a href="#具体原因" class="headerlink" title="具体原因"></a>具体原因</h3><ol>
<li><strong><code>setlocal</code> 与 <code>endlocal</code> 作用域</strong>：<ul>
<li>如果你在 <code>setlocal</code> 之后定义的变量（比如 <code>hours</code>、<code>minutes</code>、<code>seconds</code>），当执行 <code>endlocal</code> 后，这些变量将失效。</li>
<li>当 <code>endlocal</code> 执行后，如果想要将 <code>setlocal</code> 作用域中的局部变量的值传递到全局变量，就需要使用一些技巧。</li>
</ul>
</li>
<li><strong>为什么用两次 <code>set</code></strong>：<ul>
<li>在 <code>endlocal</code> 之后，如果想将局部变量的值传递到全局变量，需要在 <code>endlocal</code> 后立即执行 <code>set</code> 命令，因为 <code>endlocal</code> 会让局部变量失效。</li>
<li>由于 <code>endlocal</code> 会立即生效，直接用 <code>set</code> 的话，局部变量 <code>hours</code>、<code>minutes</code> 和 <code>seconds</code> 会在 <code>endlocal</code> 执行后失效，从而导致无法正确将其值赋值给全局变量。因此，使用 <code>endlocal &amp; set</code> 语法来在执行 <code>endlocal</code> 之前保存变量的值，然后在 <code>set</code> 中应用这些值。</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="问-运算结果不符"><a href="#问-运算结果不符" class="headerlink" title="问:运算结果不符"></a>问:运算结果不符</h3><blockquote>
<h3 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h3><p>其实上述脚本还存在问题,当bat脚本跑起来后,发现计算的值与实际不符,最后在 TimeToSeconds 函数逐步echo发现,最后一步</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> /a %1=hours*3600 + minutes*60 + seconds</span><br></pre></td></tr></table></figure>
<p>这一步这里不会计算导致出现问题，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">D:\WorkFile\20241008&gt;test.bat</span><br><span class="line">Start time: 10:24:18.30</span><br><span class="line">End time: 10:24:23.19</span><br><span class="line">Elapsed Time: 0 hour(s), 48 minute(s), 41 second(s)</span><br><span class="line">请按任意键继续. . .</span><br></pre></td></tr></table></figure>
<h3 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">endlocal</span> &amp; <span class="built_in">set</span> <span class="variable">%1=%</span>hours% * <span class="number">3600</span> + <span class="variable">%minutes%</span> * <span class="number">60</span> + <span class="variable">%seconds%</span></span><br></pre></td></tr></table></figure>
<p>这行代码实际上会把 <code>%hours% * 3600 + %minutes% * 60 + %seconds%</code> 这个表达式当作<strong>字符串</strong>赋值给变量 <code>%1</code>，而不会进行实际的数学运算。原因是 <code>set</code> 命令默认是字符串操作，除非用 <code>/a</code> 参数来强制进行算术运算（如：<code>set /a</code>）。</p>
<p>例如：</p>
<ul>
<li>假设 <code>hours=2</code>，<code>minutes=30</code>，<code>seconds=15</code>。</li>
<li>执行上面的语句时，它不会计算 <code>2 * 3600 + 30 * 60 + 15</code> 的结果，而是直接将字符串 <code>&quot;2 * 3600 + 30 * 60 + 15&quot;</code> 赋值给变量 <code>%1</code>。</li>
<li>当你试图 <code>echo</code> 或使用 <code>%1</code> 变量时，它的内容是 <code>&quot;2 * 3600 + 30 * 60 + 15&quot;</code>（而不是 <code>9015</code>），所以不能得到正确的结果。</li>
</ul>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>如果希望在 <code>endlocal</code> 之后将计算结果传递给全局变量，可以使用下面的技巧：</p>
<ol>
<li><strong>在 <code>endlocal</code> 之前计算出结果</strong>，并通过命令行传递到 <code>endlocal</code> 之后。</li>
<li>使用 <strong>临时文件</strong> 或其他方法将值传递到 <code>endlocal</code> 之后。</li>
</ol>
<h3 id="方法-1：通过-setlocal-中的临时变量传递值"><a href="#方法-1：通过-setlocal-中的临时变量传递值" class="headerlink" title="方法 1：通过 setlocal 中的临时变量传递值"></a>方法 1：通过 <code>setlocal</code> 中的临时变量传递值</h3><p>一种常见的做法是先用一个临时变量存储计算结果，然后使用 <code>endlocal &amp;</code> 语法将该值传递给全局变量：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line"><span class="built_in">set</span> hours=<span class="number">2</span></span><br><span class="line"><span class="built_in">set</span> minutes=<span class="number">30</span></span><br><span class="line"><span class="built_in">set</span> seconds=<span class="number">15</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM 在局部变量范围内计算总秒数</span></span><br><span class="line"><span class="built_in">set</span> /a total_seconds=hours*<span class="number">3600</span> + minutes*<span class="number">60</span> + seconds</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM 通过临时变量传递总秒数</span></span><br><span class="line"><span class="built_in">endlocal</span> &amp; <span class="built_in">set</span> total_seconds=<span class="variable">%total_seconds%</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Total seconds: <span class="variable">%total_seconds%</span></span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure>
<h3 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h3><ol>
<li><strong>局部变量计算</strong>：<ul>
<li>在 <code>setlocal</code> 范围内，计算了 <code>total_seconds</code> 的值（即 <code>2*3600 + 30*60 + 15 = 9015</code>）。</li>
</ul>
</li>
<li><strong>传递临时变量</strong>：<ul>
<li>使用 <code>endlocal &amp; set total_seconds=%total_seconds%</code>，将 <code>total_seconds</code> 的值从 <code>setlocal</code> 范围内传递到全局变量中。</li>
<li>在执行 <code>endlocal</code> 之前，<code>%total_seconds%</code> 的值就已经被解析为 <code>9015</code>（局部作用域中计算出的值）。</li>
</ul>
</li>
<li><strong>输出结果</strong>：<ul>
<li><code>total_seconds</code> 的全局变量现在已经是 <code>9015</code>，因此可以在 <code>echo</code> 中正确输出。</li>
</ul>
</li>
</ol>
<h3 id="方法-2：使用-setlocal-和-endlocal-同时传递多个变量"><a href="#方法-2：使用-setlocal-和-endlocal-同时传递多个变量" class="headerlink" title="方法 2：使用 setlocal 和 endlocal 同时传递多个变量"></a>方法 2：使用 <code>setlocal</code> 和 <code>endlocal</code> 同时传递多个变量</h3><p>假设你希望将多个变量值传递到全局作用域，可以采用如下方式：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line"><span class="built_in">set</span> hours=<span class="number">2</span></span><br><span class="line"><span class="built_in">set</span> minutes=<span class="number">30</span></span><br><span class="line"><span class="built_in">set</span> seconds=<span class="number">15</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM 计算各变量的总秒数</span></span><br><span class="line"><span class="built_in">set</span> /a total_seconds=hours*<span class="number">3600</span> + minutes*<span class="number">60</span> + seconds</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM 使用endlocal传递多个变量的值</span></span><br><span class="line"><span class="built_in">endlocal</span> &amp; (</span><br><span class="line">    <span class="built_in">set</span> &quot;hours=<span class="variable">%hours%</span>&quot; ^</span><br><span class="line">    &amp; <span class="built_in">set</span> &quot;minutes=<span class="variable">%minutes%</span>&quot; ^</span><br><span class="line">    &amp; <span class="built_in">set</span> &quot;seconds=<span class="variable">%seconds%</span>&quot; ^</span><br><span class="line">    &amp; <span class="built_in">set</span> &quot;total_seconds=<span class="variable">%total_seconds%</span>&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Hours: <span class="variable">%hours%</span></span><br><span class="line"><span class="built_in">echo</span> Minutes: <span class="variable">%minutes%</span></span><br><span class="line"><span class="built_in">echo</span> Seconds: <span class="variable">%seconds%</span></span><br><span class="line"><span class="built_in">echo</span> Total seconds: <span class="variable">%total_seconds%</span></span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure>
<h3 id="解析-1"><a href="#解析-1" class="headerlink" title="解析"></a>解析</h3><ol>
<li><strong>局部变量计算</strong>：<ul>
<li>在 <code>setlocal</code> 范围内，定义了 <code>hours</code>、<code>minutes</code>、<code>seconds</code> 并计算了 <code>total_seconds</code>。</li>
</ul>
</li>
<li><strong>同时传递多个变量</strong>：<ul>
<li>使用 <code>endlocal &amp; (...)</code> 的方式，传递了多个变量值。</li>
<li><code>^</code> 是转义符，用于表示当前行没有结束，下一行仍然属于同一个命令块。</li>
<li><code>set &quot;var=value&quot;</code> 中使用双引号，可以确保变量值中包含空格或其他特殊字符时能够正确处理。</li>
</ul>
</li>
<li><strong>输出结果</strong>：<ul>
<li><code>hours</code>、<code>minutes</code>、<code>seconds</code> 和 <code>total_seconds</code> 变量都被成功传递到了全局作用域，因此可以正确输出它们的值。</li>
</ul>
</li>
</ol>
<h3 id="方法-3：使用-call-传递计算结果"><a href="#方法-3：使用-call-传递计算结果" class="headerlink" title="方法 3：使用 call 传递计算结果"></a>方法 3：使用 <code>call</code> 传递计算结果</h3><p>另一种方法是使用 <code>call</code> 命令，通过子例程来传递计算后的值。例如：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line"><span class="built_in">set</span> hours=<span class="number">2</span></span><br><span class="line"><span class="built_in">set</span> minutes=<span class="number">30</span></span><br><span class="line"><span class="built_in">set</span> seconds=<span class="number">15</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM 在局部变量中计算秒数</span></span><br><span class="line"><span class="built_in">set</span> /a total_seconds=hours*<span class="number">3600</span> + minutes*<span class="number">60</span> + seconds</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM 调用子例程并传递计算结果</span></span><br><span class="line"><span class="keyword">call</span> :SetGlobalVar total_seconds <span class="variable">%total_seconds%</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">endlocal</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Total seconds: <span class="variable">%total_seconds%</span></span><br><span class="line"><span class="built_in">pause</span></span><br><span class="line"><span class="keyword">exit</span> /b</span><br><span class="line"></span><br><span class="line">:SetGlobalVar</span><br><span class="line"><span class="built_in">set</span> <span class="variable">%1=%</span><span class="number">2</span></span><br><span class="line"><span class="keyword">exit</span> /b</span><br></pre></td></tr></table></figure>
<h3 id="解析-2"><a href="#解析-2" class="headerlink" title="解析"></a>解析</h3><ol>
<li><strong>局部变量计算</strong>：<ul>
<li>在 <code>setlocal</code> 范围内计算 <code>total_seconds</code>，得到的值为 <code>9015</code>。</li>
</ul>
</li>
<li><strong>通过子例程传递结果</strong>：<ul>
<li>使用 <code>call :SetGlobalVar</code> 传递计算后的值。</li>
<li><code>call :SetGlobalVar total_seconds %total_seconds%</code> 将 <code>9015</code> 的值传递给全局变量 <code>total_seconds</code>。</li>
</ul>
</li>
<li><strong>输出结果</strong>：<ul>
<li><code>total_seconds</code> 的全局变量被设置为 <code>9015</code>，因此可以在 <code>endlocal</code> 后成功输出。</li>
</ul>
</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><strong>直接用 <code>set %1=%hours% \* 3600 + %minutes% \* 60 + %seconds%</code> 不会进行数学运算</strong>，而是将表达式作为字符串进行赋值。</li>
<li>为了解决这个问题，可以先在 <code>setlocal</code> 中计算出结果，然后通过 <code>endlocal &amp; set</code> 或 <code>call</code> 的方式传递计算后的值到全局作用域。</li>
<li>以上几种方法可以根据需求来选择使用，确保局部变量的值能够在 <code>endlocal</code> 之后正确传递到全局变量中。</li>
</ul>
<h3 id="修改举例"><a href="#修改举例" class="headerlink" title="修改举例:"></a>修改举例:</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">REM 函数：将 HH:MM:SS 时间格式转换为秒数</span></span><br><span class="line">:TimeToSeconds</span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line"><span class="built_in">set</span> time_string=%~<span class="number">2</span></span><br><span class="line"><span class="built_in">set</span> /a hours=<span class="number">1</span><span class="variable">%time_string:~0,2%</span> - <span class="number">100</span></span><br><span class="line"><span class="built_in">set</span> /a minutes=<span class="number">1</span><span class="variable">%time_string:~3,2%</span> - <span class="number">100</span></span><br><span class="line"><span class="built_in">set</span> /a seconds=<span class="number">1</span><span class="variable">%time_string:~6,2%</span> - <span class="number">100</span></span><br><span class="line"><span class="built_in">set</span> /a total_seconds=hours*<span class="number">3600</span> + minutes*<span class="number">60</span> + seconds</span><br><span class="line"><span class="built_in">endlocal</span> &amp; <span class="built_in">set</span> <span class="variable">%1=%</span>total_seconds%</span><br><span class="line"><span class="keyword">exit</span> /b</span><br></pre></td></tr></table></figure></blockquote>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/04/06/python/python%20threading/" rel="prev" title="python使用 &#96;threading&#96; 模块来实现守护线程和定时任务">
                  <i class="fa fa-angle-left"></i> python使用 `threading` 模块来实现守护线程和定时任务
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/04/06/debug/debug%20Linux%20information/" rel="next" title="crash + windbg">
                  crash + windbg <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Gcmz</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
